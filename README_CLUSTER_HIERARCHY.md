# 聚类层次结构功能

本功能实现了基于HDBSCAN condensed_tree的分层聚类可视化，让用户可以探索不同lambda阈值下的聚类结果。

## 功能特性

### 1. 层次视图模式

在聚类页面 (`/clusters`) 中，点击"层次视图"按钮可以切换到层次结构展示模式。

### 2. 交互式滑块控制器

- **Lambda值滑块**: 拖动滑块可以查看不同lambda值下的聚类划分
- **播放按钮**: 自动遍历所有层级，观察聚类如何随lambda值变化
- **实时统计**: 显示当前lambda值、聚类数量和噪声点数量

### 3. 聚类稳定性指标

每个聚类都会显示：
- **层级计数**: 该聚类在多少个层级中出现（如 "15/50"）
- **稳定性标签**: 如果聚类在超过30%的层级中出现，会标记为"稳定"
- **稳定性条**: 彩色进度条表示稳定性百分比
  - 绿色: >50% 的层级（非常稳定）
  - 黄色: 20-50% 的层级（中等稳定）
  - 红色: <20% 的层级（不稳定）

### 4. 视觉反馈

- **渐入动画**: 切换层级时，聚类以交错的渐入动画出现
- **边框高亮**: 稳定的聚类使用紫色边框，不稳定的使用灰色边框
- **悬停效果**: 鼠标悬停时显示增强的视觉反馈

## 技术实现

### 数据提取

Python脚本 (`scripts/cluster_summaries.py`) 从HDBSCAN的`condensed_tree_`中提取层次结构：
- 获取所有唯一的lambda值
- 对于每个lambda值，计算该阈值下的聚类分配
- 最多采样50个层级以保持性能

### 前端缓存

层次数据使用localStorage缓存：
- 缓存有效期: 24小时
- 包含版本控制，配置变化时自动失效
- 在 `src/lib/client/cluster-hierarchy.ts` 中实现

### API响应

`/api/cluster-summaries` API现在返回`hierarchyData`字段：

```typescript
{
  success: true,
  clusters: [...],
  hierarchyData: {
    lambdaRange: [minLambda, maxLambda],
    levels: [
      {
        lambda: 1.234,
        clusters: [...],
        noiseCount: 10,
        clusterCount: 5
      },
      ...
    ]
  }
}
```

## 使用建议

1. **首次使用**: 点击"重新生成聚类"以计算并缓存层次数据
2. **探索层次**: 使用滑块从高lambda值（更多小聚类）向低lambda值（更少大聚类）滑动
3. **寻找稳定聚类**: 关注标记为"稳定"的聚类，这些通常是最有意义的分组
4. **使用播放功能**: 自动播放可以快速了解整体的聚类层次结构

## 性能考虑

- Lambda值采样限制在最多50个层级
- 前端缓存减少重复计算
- 渐进式动画避免UI卡顿
- 聚类稳定性计算使用高效的Set操作

## Lambda值说明

Lambda值在HDBSCAN中表示分离距离的倒数：
- **高lambda值** (如 10.0): 数据点必须非常接近才能在同一聚类中，产生更多小聚类
- **低lambda值** (如 0.1): 数据点可以相距较远仍在同一聚类中，产生更少大聚类

通过探索不同lambda值，您可以：
- 发现数据的自然分层结构
- 理解聚类如何合并
- 识别最稳定和最有意义的聚类

